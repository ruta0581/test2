<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WebRTC Client (視聴者)</title>
</head>
<body>
  <h2>WebRTC Client</h2>
  <video id="remoteVideo" autoplay playsinline style="width: 320px; border:1px solid #ccc"></video>
  <br>
  <button id="connectBtn">接続</button>

  <script>
    const wsUrl = "wss://temporary-signed-fares-fun.trycloudflare.com/ws";
    let ws, pc;

    document.getElementById("connectBtn").onclick = () => {
      ws = new WebSocket(wsUrl);

      ws.onmessage = async (msg) => {
        let data = JSON.parse(msg.data);
        if (data.type === "offer") {
          pc = new RTCPeerConnection();

          // 受信ストリームをvideoに表示
          pc.ontrack = e => {
            document.getElementById("remoteVideo").srcObject = e.streams[0];
          };

          // シグナリング(ICE candidate)
          pc.onicecandidate = e => {
            if (e.candidate) ws.send(JSON.stringify({ type: "candidate", candidate: e.candidate }));
          };

          await pc.setRemoteDescription(data.offer);
          let answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          ws.send(JSON.stringify({ type: "answer", answer }));

        } else if (data.type === "candidate" && pc && data.candidate) {
          try { await pc.addIceCandidate(data.candidate); } catch {}
        }
      };
    };
  </script>
</body>
</html>
