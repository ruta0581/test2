<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Client</title>
</head>
<body>
  <h2>WSSアドレスを入力</h2>
  <input id="wssUrl" placeholder="wss://..." style="width: 300px;">
  <button onclick="connect()">接続</button>
  <video id="remoteVideo" autoplay playsinline controls></video>

<script>
let pc = null, ws = null;
let clientId = null;

function connect() {
  const url = document.getElementById("wssUrl").value;

  if (ws && ws.readyState === WebSocket.OPEN) ws.close();
  if (pc) {
    pc.ontrack = null;
    pc.onicecandidate = null;
    pc.close();
    pc = null;
  }

  ws = new WebSocket(url);
  pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  });

  let candidateQueue = [];

  ws.onopen = () => {
    console.log("WebSocket opened");
    ws.send(JSON.stringify({ role: "client" }));
    // サーバーからclientIdが来るまで待つ
  };

  ws.onmessage = async ({ data }) => {
    const msg = JSON.parse(data);
    console.log("WebSocket message received:", msg);

    // サーバーからクライアントIDを受信
    if (msg.type === "client-id") {
      clientId = msg.clientId;
      // clientIdを取得してからofferを要求
      ws.send(JSON.stringify({ type: "request-offer", clientId }));
    }

    if (msg.type === "offer" && msg.clientId === clientId) {
      await pc.setRemoteDescription(new RTCSessionDescription(msg.offer));

      // 再生中に受け取った ICE を先に適用
      for (const candidate of candidateQueue) {
        await pc.addIceCandidate(new RTCIceCandidate(candidate));
      }
      candidateQueue = [];

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      ws.send(JSON.stringify({ type: "answer", answer, clientId }));
    } else if (msg.type === "candidate" && msg.clientId === clientId) {
      if (!pc.remoteDescription || !pc.remoteDescription.type) {
        candidateQueue.push(msg.candidate);
      } else {
        await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
      }
    }
  };

  ws.onclose = () => {
    alert("ホストとの接続が切断されました。");
    document.getElementById("remoteVideo").srcObject = null;
  };

  pc.ontrack = e => {
    document.getElementById("remoteVideo").srcObject = e.streams[0];
  };

  pc.onicecandidate = e => {
    if (e.candidate && clientId !== null) {
      ws.send(JSON.stringify({ type: "candidate", candidate: e.candidate, clientId }));
    }
  };
}
</script>
</body>
</html>
